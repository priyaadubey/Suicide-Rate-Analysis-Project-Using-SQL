--Trigger to Prevent Insert of Future Years
CREATE OR REPLACE TRIGGER PREVENT_FUTURE_YEARS
BEFORE INSERT OR UPDATE ON SUICIDE_STATISTICS
FOR EACH ROW
BEGIN
    IF :NEW.YEAR > EXTRACT(YEAR FROM SYSDATE) THEN
        RAISE_APPLICATION_ERROR(-20002, 'Year cannot be in the future!');
    END IF;
END;
/

--Automatic Log Changes in Data
CREATE TABLE SUICIDE_LOG (
    LOG_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOG_DATE TIMESTAMP DEFAULT SYSTIMESTAMP,
    ACTION_TYPE VARCHAR2(50),
    OLD_TOTAL NUMBER,
    NEW_TOTAL NUMBER
);

CREATE OR REPLACE TRIGGER LOG_SUICIDE_CHANGES
AFTER UPDATE ON SUICIDE_STATISTICS
FOR EACH ROW
BEGIN
    INSERT INTO SUICIDE_LOG (ACTION_TYPE, OLD_TOTAL, NEW_TOTAL)
    VALUES ('UPDATE', :OLD.TOTAL, :NEW.TOTAL);
END;
/

--Function to get suicide count
CREATE OR REPLACE FUNCTION GET_TOTAL_SUICIDES (p_year IN NUMBER) 
RETURN NUMBER 
IS
    total_suicides NUMBER;
BEGIN
    SELECT SUM(TOTAL) INTO total_suicides
    FROM SUICIDE_STATISTICS
    WHERE YEAR = p_year;

    RETURN total_suicides;
END;
/

--testing
SELECT GET_TOTAL_SUICIDES(2004) FROM dual;